import { useState, useEffect, type ChangeEvent } from 'react';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '../Select';
import { Input } from '../../atoms/Input';
import { Label } from '../../atoms/Label';
import type { PhoneInputProps, Country } from './types';

const countries: Country[] = [
  { code: 'AO', name: 'Angola', dialCode: '+244', flag: 'ðŸ‡¦ðŸ‡´' },
  { code: 'AR', name: 'Argentina', dialCode: '+54', flag: 'ðŸ‡¦ðŸ‡·' },
  { code: 'AT', name: 'Austria', dialCode: '+43', flag: 'ðŸ‡¦ðŸ‡¹' },
  { code: 'AU', name: 'Australia', dialCode: '+61', flag: 'ðŸ‡¦ðŸ‡º' },
  { code: 'BE', name: 'Belgium', dialCode: '+32', flag: 'ðŸ‡§ðŸ‡ª' },
  { code: 'BF', name: 'Burkina Faso', dialCode: '+226', flag: 'ðŸ‡§ðŸ‡«' },
  { code: 'BG', name: 'Bulgaria', dialCode: '+359', flag: 'ðŸ‡§ðŸ‡¬' },
  { code: 'BI', name: 'Burundi', dialCode: '+257', flag: 'ðŸ‡§ðŸ‡®' },
  { code: 'BW', name: 'Botswana', dialCode: '+267', flag: 'ðŸ‡§ðŸ‡¼' },
  { code: 'BR', name: 'Brazil', dialCode: '+55', flag: 'ðŸ‡§ðŸ‡·' },
  { code: 'CA', name: 'Canada', dialCode: '+1', flag: 'ðŸ‡¨ðŸ‡¦' },
  { code: 'CV', name: 'Cape Verde', dialCode: '+238', flag: 'ðŸ‡¨ðŸ‡»' },
  {
    code: 'CF',
    name: 'Central African Republic',
    dialCode: '+236',
    flag: 'ðŸ‡¨ðŸ‡«',
  },
  { code: 'TD', name: 'Chad', dialCode: '+235', flag: 'ðŸ‡¹ðŸ‡©' },
  { code: 'CL', name: 'Chile', dialCode: '+56', flag: 'ðŸ‡¨ðŸ‡±' },
  { code: 'CN', name: 'China', dialCode: '+86', flag: 'ðŸ‡¨ðŸ‡³' },
  { code: 'CG', name: 'Republic of the Congo', dialCode: '+242', flag: 'ðŸ‡¨ðŸ‡¬' },
  {
    code: 'CD',
    name: 'Democratic Republic of the Congo',
    dialCode: '+243',
    flag: 'ðŸ‡¨ðŸ‡©',
  },
  { code: 'CI', name: 'Ivory Coast', dialCode: '+225', flag: 'ðŸ‡¨ðŸ‡®' },
  { code: 'HR', name: 'Croatia', dialCode: '+385', flag: 'ðŸ‡­ðŸ‡·' },
  { code: 'CZ', name: 'Czech Republic', dialCode: '+420', flag: 'ðŸ‡¨ðŸ‡¿' },
  { code: 'DK', name: 'Denmark', dialCode: '+45', flag: 'ðŸ‡©ðŸ‡°' },
  { code: 'DJ', name: 'Djibouti', dialCode: '+253', flag: 'ðŸ‡©ðŸ‡¯' },
  { code: 'EG', name: 'Egypt', dialCode: '+20', flag: 'ðŸ‡ªðŸ‡¬' },
  { code: 'ER', name: 'Eritrea', dialCode: '+291', flag: 'ðŸ‡ªðŸ‡·' },
  { code: 'EE', name: 'Estonia', dialCode: '+372', flag: 'ðŸ‡ªðŸ‡ª' },
  { code: 'ET', name: 'Ethiopia', dialCode: '+251', flag: 'ðŸ‡ªðŸ‡¹' },
  { code: 'FI', name: 'Finland', dialCode: '+358', flag: 'ðŸ‡«ðŸ‡®' },
  { code: 'FR', name: 'France', dialCode: '+33', flag: 'ðŸ‡«ðŸ‡·' },
  { code: 'GA', name: 'Gabon', dialCode: '+241', flag: 'ðŸ‡¬ðŸ‡¦' },
  { code: 'GM', name: 'Gambia', dialCode: '+220', flag: 'ðŸ‡¬ðŸ‡²' },
  { code: 'GE', name: 'Georgia', dialCode: '+995', flag: 'ðŸ‡¬ðŸ‡ª' },
  { code: 'DE', name: 'Germany', dialCode: '+49', flag: 'ðŸ‡©ðŸ‡ª' },
  { code: 'GH', name: 'Ghana', dialCode: '+233', flag: 'ðŸ‡¬ðŸ‡­' },
  { code: 'GN', name: 'Guinea', dialCode: '+224', flag: 'ðŸ‡¬ðŸ‡³' },
  { code: 'GQ', name: 'Equatorial Guinea', dialCode: '+240', flag: 'ðŸ‡¬ðŸ‡¶' },
  { code: 'GW', name: 'Guinea-Bissau', dialCode: '+245', flag: 'ðŸ‡¬ðŸ‡¼' },
  { code: 'GR', name: 'Greece', dialCode: '+30', flag: 'ðŸ‡¬ðŸ‡·' },
  { code: 'IE', name: 'Ireland', dialCode: '+353', flag: 'ðŸ‡®ðŸ‡ª' },
  { code: 'IL', name: 'Israel', dialCode: '+972', flag: 'ðŸ‡®ðŸ‡±' },
  { code: 'IN', name: 'India', dialCode: '+91', flag: 'ðŸ‡®ðŸ‡³' },
  { code: 'IT', name: 'Italy', dialCode: '+39', flag: 'ðŸ‡®ðŸ‡¹' },
  { code: 'JP', name: 'Japan', dialCode: '+81', flag: 'ðŸ‡¯ðŸ‡µ' },
  { code: 'KE', name: 'Kenya', dialCode: '+254', flag: 'ðŸ‡°ðŸ‡ª' },
  { code: 'KM', name: 'Comoros', dialCode: '+269', flag: 'ðŸ‡°ðŸ‡²' },
  { code: 'KR', name: 'South Korea', dialCode: '+82', flag: 'ðŸ‡°ðŸ‡·' },
  { code: 'LS', name: 'Lesotho', dialCode: '+266', flag: 'ðŸ‡±ðŸ‡¸' },
  { code: 'LV', name: 'Latvia', dialCode: '+371', flag: 'ðŸ‡±ðŸ‡»' },
  { code: 'LR', name: 'Liberia', dialCode: '+231', flag: 'ðŸ‡±ðŸ‡·' },
  { code: 'LT', name: 'Lithuania', dialCode: '+370', flag: 'ðŸ‡±ðŸ‡¹' },
  { code: 'MG', name: 'Madagascar', dialCode: '+261', flag: 'ðŸ‡²ðŸ‡¬' },
  { code: 'MW', name: 'Malawi', dialCode: '+265', flag: 'ðŸ‡²ðŸ‡¼' },
  { code: 'ML', name: 'Mali', dialCode: '+223', flag: 'ðŸ‡²ðŸ‡±' },
  { code: 'YT', name: 'Mayotte', dialCode: '+262', flag: 'ðŸ‡¾ðŸ‡¹' },
  { code: 'MU', name: 'Mauritius', dialCode: '+230', flag: 'ðŸ‡²ðŸ‡º' },
  { code: 'MX', name: 'Mexico', dialCode: '+52', flag: 'ðŸ‡²ðŸ‡½' },
  { code: 'MZ', name: 'Mozambique', dialCode: '+258', flag: 'ðŸ‡²ðŸ‡¿' },
  { code: 'NA', name: 'Namibia', dialCode: '+264', flag: 'ðŸ‡³ðŸ‡¦' },
  { code: 'NE', name: 'Niger', dialCode: '+227', flag: 'ðŸ‡³ðŸ‡ª' },
  { code: 'NG', name: 'Nigeria', dialCode: '+234', flag: 'ðŸ‡³ðŸ‡¬' },
  { code: 'NL', name: 'Netherlands', dialCode: '+31', flag: 'ðŸ‡³ðŸ‡±' },
  { code: 'NO', name: 'Norway', dialCode: '+47', flag: 'ðŸ‡³ðŸ‡´' },
  { code: 'NZ', name: 'New Zealand', dialCode: '+64', flag: 'ðŸ‡³ðŸ‡¿' },
  { code: 'PL', name: 'Poland', dialCode: '+48', flag: 'ðŸ‡µðŸ‡±' },
  { code: 'PT', name: 'Portugal', dialCode: '+351', flag: 'ðŸ‡µðŸ‡¹' },
  { code: 'RE', name: 'RÃ©union', dialCode: '+262', flag: 'ðŸ‡·ðŸ‡ª' },
  { code: 'RO', name: 'Romania', dialCode: '+40', flag: 'ðŸ‡·ðŸ‡´' },
  { code: 'RU', name: 'Russia', dialCode: '+7', flag: 'ðŸ‡·ðŸ‡º' },
  { code: 'RW', name: 'Rwanda', dialCode: '+250', flag: 'ðŸ‡·ðŸ‡¼' },
  { code: 'SA', name: 'Saudi Arabia', dialCode: '+966', flag: 'ðŸ‡¸ðŸ‡¦' },
  { code: 'SC', name: 'Seychelles', dialCode: '+248', flag: 'ðŸ‡¸ðŸ‡¨' },
  { code: 'SL', name: 'Sierra Leone', dialCode: '+232', flag: 'ðŸ‡¸ðŸ‡±' },
  { code: 'SK', name: 'Slovakia', dialCode: '+421', flag: 'ðŸ‡¸ðŸ‡°' },
  { code: 'SI', name: 'Slovenia', dialCode: '+386', flag: 'ðŸ‡¸ðŸ‡®' },
  { code: 'SO', name: 'Somalia', dialCode: '+252', flag: 'ðŸ‡¸ðŸ‡´' },
  { code: 'ZA', name: 'South Africa', dialCode: '+27', flag: 'ðŸ‡¿ðŸ‡¦' },
  { code: 'SS', name: 'South Sudan', dialCode: '+211', flag: 'ðŸ‡¸ðŸ‡¸' },
  { code: 'ES', name: 'Spain', dialCode: '+34', flag: 'ðŸ‡ªðŸ‡¸' },
  { code: 'ST', name: 'SÃ£o TomÃ© and PrÃ­ncipe', dialCode: '+239', flag: 'ðŸ‡¸ðŸ‡¹' },
  { code: 'SZ', name: 'Eswatini', dialCode: '+268', flag: 'ðŸ‡¸ðŸ‡¿' },
  { code: 'SD', name: 'Sudan', dialCode: '+249', flag: 'ðŸ‡¸ðŸ‡©' },
  { code: 'SE', name: 'Sweden', dialCode: '+46', flag: 'ðŸ‡¸ðŸ‡ª' },
  { code: 'CH', name: 'Switzerland', dialCode: '+41', flag: 'ðŸ‡¨ðŸ‡­' },
  { code: 'TR', name: 'Turkey', dialCode: '+90', flag: 'ðŸ‡¹ðŸ‡·' },
  { code: 'TZ', name: 'Tanzania', dialCode: '+255', flag: 'ðŸ‡¹ðŸ‡¿' },
  { code: 'UG', name: 'Uganda', dialCode: '+256', flag: 'ðŸ‡ºðŸ‡¬' },
  { code: 'GB', name: 'United Kingdom', dialCode: '+44', flag: 'ðŸ‡¬ðŸ‡§' },
  { code: 'US', name: 'United States', dialCode: '+1', flag: 'ðŸ‡ºðŸ‡¸' },
  { code: 'AE', name: 'United Arab Emirates', dialCode: '+971', flag: 'ðŸ‡¦ðŸ‡ª' },
  { code: 'ZM', name: 'Zambia', dialCode: '+260', flag: 'ðŸ‡¿ðŸ‡²' },
  { code: 'ZW', name: 'Zimbabwe', dialCode: '+263', flag: 'ðŸ‡¿ðŸ‡¼' },
];

export const PhoneInput = ({
  value = '',
  onChange,
  onCountryChange,
  placeholder = 'Enter phone number',
  disabled = false,
  error,
  label,
  required = false,
}: PhoneInputProps) => {
  const [selectedCountry, setSelectedCountry] = useState<Country>(countries[0]);
  const [phoneNumber, setPhoneNumber] = useState('');

  // Initialize with existing value if provided
  useEffect(() => {
    if (value) {
      if (typeof value === 'string') {
        // Legacy string format - check if it's a full phone number with country code
        const countryMatch = countries.find((country) =>
          value.startsWith(country.dialCode)
        );
        if (countryMatch) {
          setSelectedCountry(countryMatch);
          setPhoneNumber(value.replace(countryMatch.dialCode, '').trim());
        } else {
          // Legacy format or just number
          setPhoneNumber(value.replace(/^\+?\d+\s*/, ''));
        }
      } else if (typeof value === 'object' && 'number' in value) {
        // New object format - extract the number and find the country
        const phoneObj = value as {
          countryCode: string;
          dialCode: string;
          number: string;
          flag: string;
        };
        const countryMatch = countries.find(
          (country) =>
            country.code === phoneObj.countryCode ||
            country.dialCode === phoneObj.dialCode
        );
        if (countryMatch) {
          setSelectedCountry(countryMatch);
        }
        setPhoneNumber(phoneObj.number || '');
      }
    } else {
      // Reset to default state when value is empty
      setPhoneNumber('');
    }
  }, [value]);

  const handleCountryChange = (countryCode: string) => {
    const country = countries.find((c) => c.code === countryCode);
    if (country) {
      setSelectedCountry(country);
      onCountryChange?.(country);

      // Update the full phone number with new country code
      const fullPhoneData = {
        countryCode: country.code,
        dialCode: country.dialCode,
        number: phoneNumber,
        flag: country.flag,
      };
      onChange?.(fullPhoneData);
    }
  };

  const handlePhoneChange = (newPhone: string) => {
    // Remove any non-digit characters except spaces and dashes
    const cleaned = newPhone.replace(/[^\d\s\-]/g, '');

    // Combine country code with phone number and return full structure
    const fullPhoneData = {
      countryCode: selectedCountry.code,
      dialCode: selectedCountry.dialCode,
      number: cleaned,
      flag: selectedCountry.flag,
    };
    onChange?.(fullPhoneData);
  };

  return (
    <div className='space-y-3'>
      {label && (
        <Label className='text-sm font-semibold text-gray-800 tracking-wide'>
          {label}
          {required && <span className='text-red-500 ml-1'>*</span>}
        </Label>
      )}

      <div className='flex space-x-2'>
        {/* Country Selector */}
        <Select
          value={selectedCountry.code}
          onValueChange={handleCountryChange}
        >
          <SelectTrigger className='w-40 h-11 rounded-xl border border-gray-200 bg-white px-3 py-3 text-sm text-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 disabled:cursor-not-allowed disabled:opacity-50 transition-all duration-300 hover:border-gray-300'>
            <SelectValue>
              <div className='flex items-center justify-center space-x-2'>
                <span className='text-lg'>{selectedCountry.flag}</span>
                <span className='text-xs font-medium leading-none'>
                  {selectedCountry.dialCode}
                </span>
              </div>
            </SelectValue>
          </SelectTrigger>
          <SelectContent>
            {countries.map((country) => (
              <SelectItem key={country.code} value={country.code}>
                <div className='flex items-center space-x-3'>
                  <span className='text-lg'>{country.flag}</span>
                  <span className='text-sm font-medium'>{country.name}</span>
                  <span className='text-xs text-gray-500'>
                    {country.dialCode}
                  </span>
                </div>
              </SelectItem>
            ))}
          </SelectContent>
        </Select>

        {/* Phone Number Input */}
        <Input
          type='tel'
          value={phoneNumber}
          onChange={(e: ChangeEvent<HTMLInputElement>) => {
            const newValue = e.target.value;
            setPhoneNumber(newValue);
            handlePhoneChange(newValue);
          }}
          placeholder={placeholder}
          disabled={disabled}
          className='flex-1'
        />
      </div>

      {error && <p className='text-sm text-red-600 font-medium'>{error}</p>}
    </div>
  );
};

export default PhoneInput;
